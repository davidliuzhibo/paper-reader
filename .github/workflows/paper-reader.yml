name: Paper Reader - 论文解读自动化

on:
  # 定时执行（每天北京时间早上9点）
  schedule:
    - cron: '0 1 * * *'  # UTC 01:00 = 北京时间 09:00

  # 手动触发，支持传入论文URL
  workflow_dispatch:
    inputs:
      paper_url:
        description: '论文PDF URL (可选，留空则处理 papers/ 目录下的文件)'
        required: false
        type: string
      paper_path:
        description: '仓库内论文路径 (可选，如 papers/example.pdf)'
        required: false
        type: string

  # 当 papers/ 目录有新文件推送时触发
  push:
    paths:
      - 'papers/*.pdf'

jobs:
  read-paper:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # 用于提交生成的解读文件

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install claude-agent-sdk anyio httpx PyPDF2

      - name: Create papers directory if not exists
        run: mkdir -p papers outputs

      - name: Download paper from URL (if provided)
        if: ${{ github.event.inputs.paper_url != '' }}
        run: |
          curl -L -o papers/downloaded_paper.pdf "${{ github.event.inputs.paper_url }}"
          echo "PAPER_PATH=papers/downloaded_paper.pdf" >> $GITHUB_ENV

      - name: Set paper path from input
        if: ${{ github.event.inputs.paper_path != '' }}
        run: |
          echo "PAPER_PATH=${{ github.event.inputs.paper_path }}" >> $GITHUB_ENV

      - name: Find latest paper (if no input provided)
        if: ${{ github.event.inputs.paper_url == '' && github.event.inputs.paper_path == '' }}
        run: |
          # 查找 papers/ 目录下最新的 PDF 文件
          LATEST_PAPER=$(find papers -name "*.pdf" -type f -printf '%T@ %p\n' 2>/dev/null | sort -rn | head -1 | cut -d' ' -f2-)
          if [ -z "$LATEST_PAPER" ]; then
            echo "No PDF files found in papers/ directory"
            echo "SKIP_PROCESSING=true" >> $GITHUB_ENV
          else
            echo "Found paper: $LATEST_PAPER"
            echo "PAPER_PATH=$LATEST_PAPER" >> $GITHUB_ENV
          fi

      - name: Run Paper Reader with Claude Agent SDK
        if: ${{ env.SKIP_PROCESSING != 'true' }}
        env:
          # Claude API 配置（通过 yunwu.ai 代理）
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          # 阿里通义万相配置
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
          # 论文路径
          PAPER_PATH: ${{ env.PAPER_PATH }}
        run: |
          python scripts/cloud_paper_reader.py

      - name: Upload outputs as artifacts
        if: ${{ env.SKIP_PROCESSING != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: paper-explanation-${{ github.run_number }}
          path: outputs/
          retention-days: 30

      - name: Commit and push outputs
        if: ${{ env.SKIP_PROCESSING != 'true' }}
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add outputs/
          git diff --staged --quiet || git commit -m "Add paper explanation - $(date +%Y%m%d-%H%M%S)

          Co-Authored-By: Claude Agent SDK <noreply@anthropic.com>"
          git push

      - name: Summary
        if: ${{ env.SKIP_PROCESSING != 'true' }}
        run: |
          echo "## Paper Reader Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Paper**: \`$PAPER_PATH\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Output**: Check the \`outputs/\` directory" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts**: Available for download" >> $GITHUB_STEP_SUMMARY
